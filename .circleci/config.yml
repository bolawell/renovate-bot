---
version: 2.1

executors:
  node:
    docker:
      - image: cimg/node:16.4.0

commands:
  setup_env:
    steps:
      - checkout
      - restore_cache:
          # When lock file changes, use increasingly general patterns to
          # restore cache
          keys:
            - node-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - node-v1-{{ .Branch }}-
            - node-v1-
      - run:
          name: Install renovate
          command: |
            export NPM_CONFIG_PREFIX=${CIRCLE_WORKING_DIRECTORY}/node_modules
            npm install -g npm@latest
            npm install
      - save_cache:
          key: node-v1-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - node_modules

jobs:
  run-renovate:
    executor: node
    steps:
      - setup_env
      - run:
          name: Run renovate
          command: npm run renovate -- --dry-run true

workflows:
  version: 2
  run-renovate:
    jobs:
      - run-renovate:
          context: renovate-bot
          filters:
            branches:
              only: master
  work-days:
    triggers:
      - schedule:
          # Monday to Friday, every hour between 9-16
          cron: "0 9-16 * * 1-5"
          filters:
            branches:
              only:
                - master
    jobs:
      - run-renovate:
          context: renovate-bot
